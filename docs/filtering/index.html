<!DOCTYPE html><html><head><title>documentation: Filtering</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Marcin Jakubowski" /><meta name="description" content="Read and write Parquet files using Scala" /><meta name="og:image" content="/parquet4s/img/poster.png" /><meta name="image" property="og:image" content="/parquet4s/img/poster.png" /><meta name="og:title" content="documentation: Filtering" /><meta name="title" property="og:title" content="documentation: Filtering" /><meta name="og:site_name" content="documentation" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Read and write Parquet files using Scala" /><link rel="icon" type="image/png" href="/parquet4s/img/favicon.png" /><meta name="twitter:title" content="documentation: Filtering" /><meta name="twitter:image" content="/parquet4s/img/poster.png" /><meta name="twitter:description" content="Read and write Parquet files using Scala" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/parquet4s/img/favicon-16x16.png" /><link rel="icon" type="image/png" sizes="32x32" href="/parquet4s/img/favicon-32x32.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/parquet4s/highlight/styles/vs.css" /><link rel="stylesheet" href="/parquet4s/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/parquet4s/" class="brand"><div class="brand-wrapper"></div><span>documentation</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/parquet4s/docs" title="Introduction" class="">Introduction</a></div> <div class="sidebar-nav-item  "><a href="/parquet4s/docs/quick_start" title="Quick Start" class="">Quick Start</a></div> <div class="sidebar-nav-item  "><a href="/parquet4s/docs/akka" title="Integration with Akka Streams" class="">Integration with Akka Streams</a></div> <div class="sidebar-nav-item  "><a href="/parquet4s/docs/pekko" title="Integration with Pekko Streams" class="">Integration with Pekko Streams</a></div> <div class="sidebar-nav-item  "><a href="/parquet4s/docs/fs2" title="Integration with FS2" class="">Integration with FS2</a></div> <div class="sidebar-nav-item  "><a href="/parquet4s/docs/storage_types" title="Supported storage types" class="">Supported storage types</a></div> <div class="sidebar-nav-item  "><a href="/parquet4s/docs/records_and_schema" title="Records, types and schema" class="">Records, types and schema</a></div> <div class="sidebar-nav-item  "><a href="/parquet4s/docs/projection" title="Projection" class="">Projection</a></div> <div class="sidebar-nav-item active "><a href="/parquet4s/docs/filtering" title="Filtering" class="active">Filtering</a></div> <div class="sidebar-nav-item  "><a href="/parquet4s/docs/partitioning" title="Partitioning" class="">Partitioning</a></div> <div class="sidebar-nav-item  "><a href="/parquet4s/docs/statistics" title="Statistics" class="">Statistics</a></div> <div class="sidebar-nav-item  "><a href="/parquet4s/docs/examples" title="Examples" class="">Examples</a></div> <div class="sidebar-nav-item  "><a href="/parquet4s/docs/migration" title="Migration from 1.x" class="">Migration from 1.x</a></div> <div class="sidebar-nav-item  "><a href="/parquet4s/docs/etl" title="(Experimental) ETL" class="">(Experimental) ETL</a></div> <div class="sidebar-nav-item  "><a href="/parquet4s/docs/protobuf" title="(Experimental) Protobuf" class="">(Experimental) Protobuf</a></div> <div class="sidebar-nav-item  "><a href="/parquet4s/docs/sponsors" title="Distinguished Sponsors" class="">Distinguished Sponsors</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/mjakubowski84/parquet4s" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/mjakubowski84/parquet4s" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="mjakubowski84" data-github-repo="parquet4s"><div class="content-wrapper"><section><h1 id="filtering">Filtering</h1>

<p>One of the best features of Parquet is an efficient way of filtering. Parquet files contain additional metadata that can be leveraged to drop chunks of data without scanning them. Parquet4s allows users to define filter predicates in order to push filtering out from Scala collections and Akka / Pekko or FS2 stream down to a point before file content is even read.</p>

<p>In Akka / Pekko and FS2 filter applies both to the content of files and <a href="/parquet4s/docs/partitioning/">partitions</a>.</p>

<p>You define your filters using simple algebra as follows:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.github.mjakubowski84.parquet4s.</span><span class="o">{</span><span class="nc">Col</span><span class="o">,</span> <span class="nc">ParquetReader</span><span class="o">,</span> <span class="nc">Path</span><span class="o">}</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">email</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">visits</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span>

<span class="nc">ParquetReader</span>
  <span class="o">.</span><span class="py">as</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span>
  <span class="o">.</span><span class="py">filter</span><span class="o">(</span><span class="nc">Col</span><span class="o">(</span><span class="s">"email"</span><span class="o">)</span> <span class="o">===</span> <span class="s">"user@email.com"</span> <span class="o">&amp;&amp;</span> <span class="nc">Col</span><span class="o">(</span><span class="s">"visits"</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="o">)</span>
  <span class="o">.</span><span class="py">read</span><span class="o">(</span><span class="nc">Path</span><span class="o">(</span><span class="s">"file.parquet"</span><span class="o">))</span>
</code></pre></div></div>

<p>You can construct filter predicates using <code class="language-plaintext highlighter-rouge">===</code>, <code class="language-plaintext highlighter-rouge">!==</code>, <code class="language-plaintext highlighter-rouge">&gt;</code>, <code class="language-plaintext highlighter-rouge">&gt;=</code>, <code class="language-plaintext highlighter-rouge">&lt;</code>, <code class="language-plaintext highlighter-rouge">&lt;=</code>, <code class="language-plaintext highlighter-rouge">in</code> and <code class="language-plaintext highlighter-rouge">udp</code> operators on columns containing primitive values. You can combine and modify predicates using <code class="language-plaintext highlighter-rouge">&amp;&amp;</code>, <code class="language-plaintext highlighter-rouge">||</code> and <code class="language-plaintext highlighter-rouge">!</code> operators. <code class="language-plaintext highlighter-rouge">in</code> looks for values in a list of keys, similar to SQLâ€™s <code class="language-plaintext highlighter-rouge">in</code> operator. Please mind that filtering on <code class="language-plaintext highlighter-rouge">java.sql.Timestamp</code> and <code class="language-plaintext highlighter-rouge">java.time.LocalDateTime</code> is not supported for <code class="language-plaintext highlighter-rouge">Int96</code> timestamps which is a default type used for timestamps. Consider a different timestamp <a href="/parquet4s/docs/records_and_schema/">format</a> for your data to enable filtering.</p>

<p>For custom filtering by a column of type <code class="language-plaintext highlighter-rouge">T</code> implement <code class="language-plaintext highlighter-rouge">UDP[T]</code> trait and use <code class="language-plaintext highlighter-rouge">udp</code> operator.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.github.mjakubowski84.parquet4s.</span><span class="o">{</span><span class="nc">Col</span><span class="o">,</span> <span class="nc">FilterStatistics</span><span class="o">,</span> <span class="nc">ParquetReader</span><span class="o">,</span> <span class="nc">Path</span><span class="o">,</span> <span class="nc">UDP</span><span class="o">}</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">MyRecord</span><span class="o">(</span><span class="n">int</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>

<span class="k">object</span> <span class="nc">IntDividesBy10</span> <span class="k">extends</span> <span class="nc">UDP</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">private</span> <span class="k">val</span> <span class="nv">Ten</span> <span class="k">=</span> <span class="mi">10</span>
  
  <span class="c1">// Called for each individual row that belongs to a row group that passed row group filtering.</span>
  <span class="k">override</span> <span class="k">def</span> <span class="nf">keep</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="n">value</span> <span class="o">%</span> <span class="nc">Ten</span> <span class="o">==</span> <span class="mi">0</span>
  
  <span class="c1">// Called for each row group.</span>
  <span class="c1">// It should contain a logic that eliminates a whole row group if statistics prove that it doesn't contain </span>
  <span class="c1">// data matching the predicate.</span>
  <span class="nd">@inline</span>
  <span class="k">override</span> <span class="k">def</span> <span class="nf">canDrop</span><span class="o">(</span><span class="n">statistics</span><span class="k">:</span> <span class="kt">FilterStatistics</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">minMod</span> <span class="k">=</span> <span class="nv">statistics</span><span class="o">.</span><span class="py">min</span> <span class="o">%</span> <span class="nc">Ten</span>
    <span class="k">val</span> <span class="nv">maxMod</span> <span class="k">=</span> <span class="nv">statistics</span><span class="o">.</span><span class="py">max</span> <span class="o">%</span> <span class="nc">Ten</span>
    <span class="o">(</span><span class="nv">statistics</span><span class="o">.</span><span class="py">max</span> <span class="o">-</span> <span class="nv">statistics</span><span class="o">.</span><span class="py">min</span> <span class="o">&lt;</span> <span class="nc">Ten</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">maxMod</span> <span class="o">&gt;=</span> <span class="n">minMod</span>
  <span class="o">}</span>
  
  <span class="c1">// Called for each row group for "not" predicates. The logic might be different than one in `canDrop`.</span>
  <span class="k">override</span> <span class="k">def</span> <span class="nf">inverseCanDrop</span><span class="o">(</span><span class="n">statistics</span><span class="k">:</span> <span class="kt">FilterStatistics</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">!</span><span class="nf">canDrop</span><span class="o">(</span><span class="n">statistics</span><span class="o">)</span>
  
  <span class="c1">// called by `toString`</span>
  <span class="k">override</span> <span class="k">val</span> <span class="nv">name</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"IntDividesBy10"</span>
<span class="o">}</span>

<span class="nc">ParquetReader</span>
  <span class="o">.</span><span class="py">as</span><span class="o">[</span><span class="kt">MyRecord</span><span class="o">]</span>
  <span class="o">.</span><span class="py">filter</span><span class="o">(</span><span class="nc">Col</span><span class="o">(</span><span class="s">"int"</span><span class="o">).</span><span class="py">udp</span><span class="o">(</span><span class="nc">IntDividesBy10</span><span class="o">))</span>
  <span class="o">.</span><span class="py">read</span><span class="o">(</span><span class="nc">Path</span><span class="o">(</span><span class="s">"my_ints.parquet"</span><span class="o">))</span>
</code></pre></div></div>

<h2 id="record-filter-experimental">Record filter [experimental]</h2>

<p><code class="language-plaintext highlighter-rouge">RecordFilter</code> is an alternative to filter predicates. It allows to filter records based on record index, that is an ordinal of a record in the file.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.github.mjakubowski84.parquet4s.</span><span class="o">{</span><span class="nc">ParquetReader</span><span class="o">,</span> <span class="nc">Path</span><span class="o">,</span> <span class="nc">RecordFilter</span><span class="o">}</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">email</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">visits</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span>

<span class="c1">// skips first 10 users</span>
<span class="nc">ParquetReader</span>
  <span class="o">.</span><span class="py">as</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span>
  <span class="o">.</span><span class="py">filter</span><span class="o">(</span><span class="nc">RecordFilter</span><span class="o">(</span><span class="n">index</span> <span class="k">=&gt;</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="o">))</span>
  <span class="o">.</span><span class="py">read</span><span class="o">(</span><span class="nc">Path</span><span class="o">(</span><span class="s">"file.parquet"</span><span class="o">))</span>
</code></pre></div></div>
</section></div></div></div></div><script src="/parquet4s/highlight/highlight.pack.js"></script><script src="/parquet4s/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script src="/parquet4s/js/search.js"></script><script src="/parquet4s/js/docs.js"></script></body></html>